import telebot
import os
from flask import Flask
import time
from threading import Thread

# üîë –¢–≤—ñ–π —Ç–æ–∫–µ–Ω (–≤–∫–∞–∂–∏ —Å–≤—ñ–π —É Koyeb -> Environment Variables -> TELEGRAM_TOKEN)
TOKEN = os.getenv("TELEGRAM_TOKEN")

# –°—Ç–≤–æ—Ä—é—î–º–æ –±–æ—Ç–∞ –∑ –±—ñ–ª—å—à–∏–º —Ç–∞–π–º–∞—É—Ç–æ–º, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ ReadTimeout
bot = telebot.TeleBot(TOKEN, request_timeout=60)
app = Flask(__name__)

# üñêÔ∏è –ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤
@bot.message_handler(content_types=['new_chat_members'])
def greet_new_member(message):
    for new_member in message.new_chat_members:
        mention = f"@{new_member.username}" if new_member.username else new_member.first_name
        text = (
            f"üëã –õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ —É –Ω–∞—à—É –¥—Ä—É–∂–Ω—é —Ä–æ–¥–∏–Ω—É, {mention}!\n\n"
            f"–û–∑–Ω–∞–π–æ–º—Å—è –∑ –≥—ñ–ª–∫–∞–º–∏ ‚Äî —Ç–∞–º —î –≤–∞–∂–ª–∏–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è üòé\n"
            f"–ó–∞–∫–∏–¥–∞–π —Ñ–æ—Ç–∫—É —Å–≤–æ–≥–æ VAG, —Ö–∞–π –≤—Å—ñ –æ—Ü—ñ–Ω—è—Ç—å üöóüí®üòâ"
        )
        bot.send_message(message.chat.id, text)

# üåê Flask-—Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ
@app.route('/')
def home():
    return "–ë–æ—Ç –ø—Ä–∞—Ü—é—î —Å—Ç–∞–±—ñ–ª—å–Ω–æ üöÄ"

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞ –∑ –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–∏–º –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è–º —ñ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
def run_bot():
    while True:
        try:
            bot.infinity_polling()
        except Exception as e:
            print(f"‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞: {e}. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...")
            time.sleep(5)

if __name__ == "__main__":
    print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–∏–π —ñ –ø—Ä–∞—Ü—é—î 24/7...")
    # –ó–∞–ø—É—Å–∫–∞—î–º–æ –±–æ—Ç–∞ –≤ –æ–∫—Ä–µ–º–æ–º—É –ø–æ—Ç–æ—Ü—ñ
    Thread(target=run_bot).start()
    # –ó–∞–ø—É—Å–∫–∞—î–º–æ Flask –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ —Ö–æ—Å—Ç–∏–Ω–≥—É
    app.run(host="0.0.0.0", port=int(os.getenv("PORT", 8080)))
